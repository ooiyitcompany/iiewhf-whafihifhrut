<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Upload Product</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <!-- Google Maps + Places Autocomplete -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWlcGVF9zF8jSKCxlECIhof1Mhe5HIfyM&libraries=places"></script>

  <!-- Selectize + Sortable -->
  <link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f4f6f8;
    padding: 1rem;
    margin-bottom: 80px;
  }

  form {
    max-width: 600px;
    margin: auto;
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  label {
    display: block;
    margin-top: 1.2rem;
    font-weight: 600;
    color: #333;
  }

  .price-input {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
  }

  .currency-symbol {
    font-size: 1.2em;
    font-weight: 600;
    color: #555;
    min-width: 24px;
  }

  input,
  textarea,
  select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
  }

  textarea {
    resize: vertical;
  }

  .photo-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }

  .photo-box {
    position: relative;
    width: 80px;
    height: 80px;
    cursor: grab;
  }

  .photo-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  .photo-box button {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #e53935;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 14px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
  }

  .submit-btn {
    margin-top: 2rem;
    background: #28a745;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: background 0.2s ease;
  }

  .submit-btn:hover {
    background: #218838;
  }
</style>

</head>
<body>

<h2>Upload New Product</h2>

<form id="uploadForm">
  <label>Product Name</label>
  <input type="text" name="productName" maxlength="60" required/>

  <label>Description</label>
  <textarea name="description" rows="4" required></textarea>

  <label>Price</label>
  <div class="price-input">
    <span class="currency-symbol" id="currencySymbol">₹</span>
    <input type="number" step="0.01" name="price" min="0.01" required/>
  </div>

  <label>Select Category</label>
  <select id="categorySelect" name="category" required>
    <option value="">-- Select Category --</option>
    <option>Service</option>
    <option>Plumber</option>
    <option>Electrician</option>
    <option>Mechanic</option>
    <option>Repair</option>
    <option>Tutor</option>
    <option>Event Service</option>
    <option>Cleaning</option>
    <option>Moving Service</option>
    <option>IT Support</option>
    <option>Carpenter</option>
    <option>Painter</option>
    <option>Gardening</option>
    <option>Beauty Service</option>
    <option>Legal Service</option>
    <option>Financial Service</option>
    <option>Land</option>
    <option>House</option>
    <option>Room</option>
    <option>Flat</option>
    <option>Office Space</option>
    <option>Shop</option>
    <option>PG (Paying Guest)</option>
    <option>Warehouse</option>
    <option>Hostel</option>
    <option>Farm House</option>

    <option>Vehicle</option>
    <option>Car</option>
    <option>Bike</option>
    <option>Scooter</option>
    <option>Truck</option>
    <option>Bus</option>
    <option>Auto Rickshaw</option>
    <option>Cycle</option>
    <option>Spare Parts</option>
    <option>Tyres</option>
    <option>Vehicle Accessories</option>

    <option>Mobile</option>
    <option>Tablet</option>
    <option>Laptop</option>
    <option>Computer</option>
    <option>TV</option>
    <option>Fridge</option>
    <option>Washing Machine</option>
    <option>Camera</option>
    <option>Home Appliances</option>
    <option>Gadget</option>
    <option>AC / Cooler</option>
    <option>Heater</option>
    <option>Gaming Console</option>
    <option>Smartwatch</option>
    <option>Printer</option>
    <option>Router</option>

    <option>Job</option>
    <option>Part Time Job</option>
    <option>Internship</option>
    <option>Tuition</option>
    <option>Coaching</option>
    <option>Freelance</option>
    <option>Remote Work</option>
    <option>Government Job</option>
    <option>Walk-in Interview</option>
    <option>Exam Preparation</option>

    <!-- Fashion & Personal -->
    <option>Fashion</option>
    <option>Clothing</option>
    <option>Shoes</option>
    <option>Watch</option>
    <option>Jewellery</option>
    <option>Cosmetics</option>
    <option>Eyewear</option>
    <option>Bags</option>
    <option>Accessories</option>
    <option>Perfume</option>
    <option>Furniture</option>
    <option>Mattress</option>
    <option>Kitchen Items</option>
    <option>Tools</option>
    <option>Decor</option>
    <option>Lighting</option>
    <option>Bathroom Accessories</option>
    <option>Dining</option>
    <option>Storage</option>
    <option>Cleaning Equipment</option>

    <option>Pet</option>
    <option>Pet Food</option>
    <option>Books</option>
    <option>Toys</option>
    <option>Stationery</option>
    <option>Music</option>
    <option>Sports</option>
    <option>Outdoor</option>
    <option>Fitness</option>
    <option>Collectibles</option>
    <option>Antiques</option>
    <option>Other</option>
  </select>

  <label>Type Product</label>
  <input type="text" name="type" placeholder="New, Used, Refurbished" required/>

  <label>Product Photos (Max 10)</label>
  <input type="file" id="photosInput" multiple accept="image/*"/>
  <div class="photo-preview" id="photoPreview"></div>

  <label>Product Location</label>
  <input type="text" id="locationInput" name="location" placeholder="Type or autocomplete" required/>
  <input type="hidden" id="lat" name="latitude"/>
  <input type="hidden" id="lng" name="longitude"/>

  <button type="submit" class="submit-btn">Upload Product</button>
</form>

<script>
  // Country code ↔ symbol map
  const currencyMap = {
    "IN": "₹", "US": "$", "CA": "$", "GB": "£", "EU": "€", "JP": "¥", "AU": "$",
    "CN": "¥", "RU": "₽", "BR": "R$", "MX": "$", "ZA": "R", "SG": "S$", "MY": "RM",
    "ID": "Rp", "PK": "₨", "BD": "৳"
  };
  function setCurrencySymbol(countryCode) {
    const symbol = currencyMap[countryCode] || "$";
    document.getElementById('currencySymbol').textContent = symbol;
  }

  // Firebase init
  firebase.initializeApp({
    apiKey: "AIzaSyAZK9TwSJAh2zrp7LxkUHfQur0pBsrnCfk",
    authDomain: "ooiy-in.firebaseapp.com",
    projectId: "ooiy-in",
    storageBucket: "ooiy-in.firebasestorage.app",
    messagingSenderId: "782642713796",
    appId: "1:782642713796:web:821e8bc94d116db26d6591",
    measurementId: "G-QHMLZ4WH73"
  });
  const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

  // Photo preview
  const photosInput = document.getElementById('photosInput'), photoPreview = document.getElementById('photoPreview');
  let selectedPhotos = [];
  photosInput.addEventListener('change', e => {
    const files = Array.from(e.target.files);
    if (selectedPhotos.length + files.length > 10) return alert("Max 10 photos.");
    files.forEach(f => {
      selectedPhotos.push(f);
      const r = new FileReader();
      r.onload = ev => {
        const box = document.createElement('div');
        box.className = 'photo-box';
        box.dataset.name = f.name;
        box.innerHTML = `<img src="${ev.target.result}"/><button onclick="removePhoto('${f.name}')">&times;</button>`;
        photoPreview.appendChild(box);
      };
      r.readAsDataURL(f);
    });
    photosInput.value = '';
  });
  window.removePhoto = name => {
    selectedPhotos = selectedPhotos.filter(a => a.name !== name);
    Array.from(photoPreview.children)
      .filter(c => c.dataset.name === name)
      .forEach(c => c.remove());
  };
  new Sortable(photoPreview, {
    animation: 150,
    onEnd: () => {
      const order = Array.from(photoPreview.children).map(c => c.dataset.name);
      selectedPhotos.sort((a, b) => order.indexOf(a.name) - order.indexOf(b.name));
    }
  });

  // Places autocomplete
  let autocomplete;
  function initAutocomplete() {
    autocomplete = new google.maps.places.Autocomplete(document.getElementById('locationInput'), {
      types: ['geocode'], componentRestrictions: {}
    });
    autocomplete.addListener('place_changed', function() {
      const p = autocomplete.getPlace();
      if (!p.geometry) return alert("No location details found.");
      document.getElementById('lat').value = p.geometry.location.lat();
      document.getElementById('lng').value = p.geometry.location.lng();
    });
  }

  // Auto geo + currency
  function setLocationAutomatically() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude, longitude } = pos.coords;
      document.getElementById('lat').value = latitude;
      document.getElementById('lng').value = longitude;
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
        const d = await r.json();
        const a = d.address;
        document.getElementById('locationInput').value =
          [a.city||a.town||a.village||a.suburb, a.state, a.country].filter(Boolean).join(', ');
        if (d.address.country_code) {
          setCurrencySymbol(d.address.country_code.toUpperCase());
        }
      } catch(e) {
        console.warn('reverse geocode err', e);
      }
    }, e => console.warn('geo err', e), { enableHighAccuracy: true, timeout:10000 });
  }

  // Form submit with disable/enable button to prevent multiple taps
  document.getElementById('uploadForm').addEventListener('submit', async e => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = "Uploading...";

    const u = auth.currentUser;
    if (!u) {
      alert("Please log in.");
      submitBtn.disabled = false;
      submitBtn.textContent = "Upload Product";
      return;
    }

    const f = e.target;
    try {
      const data = {
        name: f.productName.value,
        description: f.description.value,
        price: parseFloat(f.price.value),
        currency: document.getElementById('currencySymbol').textContent,
        category: f.category.value,
        type: f.type.value,
        location: f.location.value,
        latitude: parseFloat(f.latitude.value),
        longitude: parseFloat(f.longitude.value),
        photos: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      for (let img of selectedPhotos) {
        const ref = storage.ref(`products/${u.uid}/${Date.now()}_${img.name}`);
        await ref.put(img);
        data.photos.push(await ref.getDownloadURL());
      }

      const uref = db.collection("details").doc(u.uid);
      const d = await uref.get();
      if (!d.exists) {
        alert("Complete your profile first.");
        location.href = "details.html";
        return;
      }

      const count = Object.keys(d.data()).filter(k => k.startsWith('product')).length;
      await uref.update({ [`product${count}`]: data });

      alert("Uploaded successfully!");
      f.reset();
      photoPreview.innerHTML = "";
      selectedPhotos = [];

    } catch (error) {
      console.error(error);
      alert("Upload failed. Please try again.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Upload Product";
    }
  });

  // On load
  window.onload = () => {
    initAutocomplete();
    setLocationAutomatically();
  };
</script>

</body>
</html>
