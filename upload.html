<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Product</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <!-- Icons + Selectize -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js"></script>

  <!-- Reorder library -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      padding: 1rem;
      margin-bottom: 80px;
    }
    form {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    .photo-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .photo-box {
      position: relative;
      cursor: grab;
    }
    .photo-box img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .photo-box button {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .submit-btn {
      margin-top: 2rem;
      background: #28a745;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>

<h2>Upload New Product</h2>

<form id="uploadForm">
  <label>Product Name</label>
  <input type="text" name="productName" required />

  <label>Description</label>
  <textarea name="description" rows="4" required></textarea>

  <label>Price (â‚¹)</label>
  <input type="number" name="price" min="1" required />

  <label>Select Category</label>
  <select id="categorySelect" name="category" placeholder="Search category..." required>
    <option value="">-- Select Category --</option>
    <option value="Land">Land</option>
    <option value="Mobile">Mobile</option>
    <option value="Laptop">Laptop</option>
    <option value="Furniture">Furniture</option>
    <option value="Vehicle">Vehicle</option>
    <option value="Fashion">Fashion</option>
  </select>

  <label>Type Product</label>
  <input type="text" name="type" placeholder="New, Used, Refurbished" required />

  <label>Product Photos (Max 10)</label>
  <input type="file" id="photosInput" multiple accept="image/*" />
  <div class="photo-preview" id="photoPreview"></div>

  <label>Product Location</label>
  <input type="text" name="location" id="locationInput" required />

  <button type="submit" class="submit-btn">Upload Product</button>
</form>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAZK9TwSJAh2zrp7LxkUHfQur0pBsrnCfk",
    authDomain: "ooiy-in.firebaseapp.com",
    projectId: "ooiy-in",
    storageBucket: "ooiy-in.firebasestorage.app",
    messagingSenderId: "782642713796",
    appId: "1:782642713796:web:821e8bc94d116db26d6591",
    measurementId: "G-QHMLZ4WH73"
    
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const photosInput = document.getElementById('photosInput');
  const photoPreview = document.getElementById('photoPreview');
  let selectedPhotos = [];

  photosInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    if ((selectedPhotos.length + files.length) > 10) {
      alert("Maximum 10 photos allowed");
      return;
    }
    files.forEach(file => {
      selectedPhotos.push(file);
      const reader = new FileReader();
      reader.onload = function (e) {
        const box = document.createElement('div');
        box.className = 'photo-box';
        box.setAttribute('data-name', file.name);
        box.innerHTML = `<img src="${e.target.result}" /><button onclick="removePhoto('${file.name}')">&times;</button>`;
        photoPreview.appendChild(box);
      }
      reader.readAsDataURL(file);
    });
    photosInput.value = "";
  });

  function removePhoto(name) {
    selectedPhotos = selectedPhotos.filter(f => f.name !== name);
    [...photoPreview.children].forEach(child => {
      if (child.getAttribute('data-name') === name) child.remove();
    });
  }

  new Sortable(photoPreview, {
    animation: 150,
    onEnd: () => {
      const names = [...photoPreview.children].map(c => c.getAttribute('data-name'));
      selectedPhotos.sort((a, b) => names.indexOf(a.name) - names.indexOf(b.name));
    }
  });

  navigator.geolocation.getCurrentPosition(async (position) => {
    const { latitude, longitude } = position.coords;
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
    const data = await response.json();
    const addr = data.address;
    document.getElementById('locationInput').value = `${addr.suburb || addr.neighbourhood || addr.city || addr.town || addr.village || ''}, ${addr.state || addr.county || ''}, ${addr.postcode || ''}`;
  }, (error) => {
    console.warn("Location not detected.");
  }, {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 0
  });

  document.getElementById('uploadForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return alert("Login required");

    const form = e.target;
    const name = form.productName.value;
    const description = form.description.value;
    const price = parseFloat(form.price.value);
    const category = form.category.value;
    const type = form.type.value;
    const location = form.location.value;

    const photoURLs = [];
    for (let i = 0; i < selectedPhotos.length; i++) {
      const file = selectedPhotos[i];
      const ref = storage.ref(`products/${user.uid}/${Date.now()}_${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      photoURLs.push(url);
    }

    const productData = {
      name,
      description,
      price,
      category,
      type,
      location,
      photos: photoURLs,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const userRef = db.collection("details").doc(user.uid);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      alert("User profile not found. Please complete profile first.");
      window.location.href = "details.html";
      return;
    }

    const data = userDoc.data();
    const productFields = Object.keys(data).filter(k => k.startsWith("product"));
    const nextIndex = productFields.length;
    const newField = `product${nextIndex}`;

    await userRef.update({
      [newField]: productData
    });

    alert("Product uploaded successfully!");
    form.reset();
    photoPreview.innerHTML = "";
    selectedPhotos = [];
  });

  window.addEventListener('DOMContentLoaded', () => {
    $('#categorySelect').selectize({
      sortField: 'text',
      create: false,
      allowEmptyOption: false,
    });
  });
</script>
</body>
</html>
