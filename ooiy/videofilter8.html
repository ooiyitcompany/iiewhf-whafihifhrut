<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cinema FX Studio</title>
    <style>
        :root { --primary: #00f2ff; --accent: #ff0055; --bg: #050505; --card: #121212; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg); color: white; margin: 0; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.5); z-index: 10;
        }
        .preview-window { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; position: relative; }
        canvas { max-width: 100%; max-height: 100%; border: 1px solid #333; }

        /* Modern UI Panels */
        .controls-panel {
            background: var(--card); padding: 20px; border-radius: 25px 25px 0 0;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .scroll-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }

        .btn-fx {
            flex: 0 0 75px; height: 75px; background: #1a1a1a; border-radius: 15px;
            border: 1px solid #333; color: #999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 10px; transition: 0.2s;
        }
        .btn-fx.active { border-color: var(--primary); color: white; background: rgba(0,242,255,0.1); box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        .btn-fx i { font-size: 18px; margin-bottom: 4px; font-style: normal; }

        .label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; display: block; }
        
        .export-group { display: flex; gap: 10px; margin-top: 5px; }
        .export-btn {
            flex: 1; padding: 16px; border-radius: 12px; border: none;
            background: linear-gradient(45deg, var(--primary), #0066ff);
            color: white; font-weight: bold; font-size: 14px;
        }

        #overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); 
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; 
        }
    </style>
</head>
<body>

    <header>
        <label style="background:#222; padding:8px 12px; border-radius:8px; font-size:12px;">
            üìÇ LOAD <input type="file" id="upload" accept="video/*" style="display:none">
        </label>
        <div style="font-weight: 800; font-size: 14px; color: var(--primary);">CINEMA STUDIO PRO</div>
    </header>

    <div class="preview-window">
        <div id="overlay"><h1 id="pct">0%</h1><p>Mastering Effects...</p></div>
        <canvas id="mainCanvas"></canvas>
    </div>

    <div class="controls-panel">
        <span class="label">Advanced Transitions & Grids</span>
        <div class="scroll-row">
            <button class="btn-fx active" onclick="setFX('normal')"><i>üí†</i>Normal</button>
            <button class="btn-fx" onclick="setFX('mosaic')"><i>üî≥</i>Mosaic</button>
            <button class="btn-fx" onclick="setFX('focus')"><i>üîç</i>Focus</button>
            <button class="btn-fx" onclick="setFX('shutter')"><i>üì∑</i>Shutter</button>
            <button class="btn-fx" onclick="setFX('scan')"><i>üéûÔ∏è</i>Scan</button>
            <button class="btn-fx" onclick="setFX('rec')"><i>üî¥</i>REC</button>
            <button class="btn-fx" onclick="setLayout(2)"><i>üåó</i>Two</button>
            <button class="btn-fx" onclick="setLayout(4)"><i>Áî∞</i>Four</button>
            <button class="btn-fx" onclick="setLayout(6)"><i>ÂÖ≠</i>Six</button>
            <button class="btn-fx" onclick="setLayout(9)"><i>‚ñ¶</i>Nine</button>
            <button class="btn-fx" onclick="setLayout(20)"><i>üé≤</i>20 Tile</button>
        </div>

        <div class="export-group">
            <button class="export-btn" id="exportBtn" onclick="exportVideo()">GENERATE EXPORT</button>
        </div>
    </div>

    <video id="vSource" loop muted playsinline style="display:none"></video>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('vSource');
    let currentFX = 'normal';
    let gridCount = 1;
    let frameCount = 0;
    let isExporting = false;

    document.getElementById('upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            video.src = URL.createObjectURL(file);
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.play();
                requestAnimationFrame(renderLoop);
            };
        }
    });

    function setFX(fx) { currentFX = fx; updateActive(); }
    function setLayout(n) { gridCount = n; updateActive(); }

    function updateActive() {
        document.querySelectorAll('.btn-fx').forEach(b => {
            const isMatch = b.getAttribute('onclick').includes(`'${currentFX}'`) || 
                          b.getAttribute('onclick').includes(`(${gridCount})`);
            b.classList.toggle('active', isMatch);
        });
    }

    function renderLoop() {
        if (!isExporting && !video.paused) {
            frameCount++;
            processFrame();
            requestAnimationFrame(renderLoop);
        }
    }

    function processFrame() {
        const w = canvas.width, h = canvas.height;
        ctx.save();
        ctx.clearRect(0,0,w,h);
        ctx.filter = 'none';

        // 1. Calculate Grid
        let cols = Math.ceil(Math.sqrt(gridCount));
        let rows = Math.ceil(gridCount / cols);
        let tw = w / cols, th = h / rows;

        // 2. Apply Optic FX before drawing
        if (currentFX === 'mosaic') {
            let size = Math.max(1, 40 - (frameCount % 100) * 0.4);
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(video, 0, 0, w/size, h/size);
            ctx.drawImage(canvas, 0, 0, w/size, h/size, 0, 0, w, h);
            ctx.imageSmoothingEnabled = true;
        } else if (currentFX === 'focus') {
            let b = Math.abs(Math.sin(frameCount * 0.05)) * 15;
            ctx.filter = `blur(${b}px) contrast(1.1)`;
        }

        // 3. Draw Grid Layout
        for (let i = 0; i < gridCount; i++) {
            let r = Math.floor(i / cols), c = i % cols;
            ctx.drawImage(video, c * tw, r * th, tw, th);
        }

        // 4. Draw Overlays (Cinema Elements)
        if (currentFX === 'shutter') {
            let pos = (Math.sin(frameCount * 0.2) * h/2) + h/2;
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, w, h/2 - pos/2);
            ctx.fillRect(0, h/2 + pos/2, w, h/2);
        } else if (currentFX === 'scan') {
            let y = (frameCount * 4) % h;
            ctx.strokeStyle = 'rgba(0, 242, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
            ctx.fillStyle = 'rgba(0, 242, 255, 0.05)';
            ctx.fillRect(0, y-50, w, 50);
        } else if (currentFX === 'rec') {
            ctx.fillStyle = (frameCount % 60 < 30) ? 'red' : 'transparent';
            ctx.beginPath(); ctx.arc(40, 40, 10, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 20px monospace';
            ctx.fillText("REC 00:00:" + String(Math.floor(video.currentTime)).padStart(2,'0'), 60, 48);
        }

        ctx.restore();
    }

    async function exportVideo() {
        if (!video.src || isExporting) return;
        isExporting = true;
        const btn = document.getElementById('exportBtn');
        btn.innerText = "RENDERING..."; btn.disabled = true;

        video.pause(); video.currentTime = 0; video.loop = false;
        const chunks = [];
        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 10000000 });

        document.getElementById('overlay').style.display = 'flex';
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `CinemaFX_Studio_${Date.now()}.webm`;
            a.click();
            setTimeout(() => window.location.reload(), 1500);
        };

        recorder.start();
        video.play();

        const track = () => {
            if (video.ended) { recorder.stop(); return; }
            processFrame(); frameCount++;
            document.getElementById('pct').innerText = Math.floor((video.currentTime/video.duration)*100) + "%";
            requestAnimationFrame(track);
        };
        track();
    }
</script>
</body>
</html>