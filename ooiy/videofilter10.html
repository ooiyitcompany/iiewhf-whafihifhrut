<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Studio</title>
    <style>
        :root { --primary: #00f2ff; --bg: #000; --card: #151517; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: white; overflow: hidden;
            font-family: -apple-system, system-ui, sans-serif;
        }

        /* Responsive Layout Container */
        .app-container {
            display: flex; flex-direction: column;
            height: 100%; width: 100%;
        }

        /* 1. Slim Header */
        header {
            height: 50px; display: flex; justify-content: space-between; 
            align-items: center; padding: 0 15px; border-bottom: 1px solid #222;
        }
        .logo { font-weight: 800; color: var(--primary); font-size: 16px; }

        /* 2. Responsive Preview Area */
        .preview-area {
            flex: 1; /* Takes up remaining space */
            display: flex; align-items: center; justify-content: center;
            background: #080808; padding: 10px; position: relative;
        }
        canvas { 
            max-width: 100%; max-height: 100%; 
            box-shadow: 0 0 30px rgba(0,0,0,1); border-radius: 4px; 
            background: #111;
        }

        /* 3. Small Bottom Panel */
        .controls {
            background: var(--card); border-top: 1px solid #333;
            padding: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        /* Mini Timeline */
        .timeline {
            display: flex; gap: 8px; overflow-x: auto; 
            margin-bottom: 12px; padding-bottom: 5px;
        }
        .clip-thumb {
            width: 50px; height: 50px; background: #222; border-radius: 6px;
            border: 2px solid #444; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center; font-size: 10px;
        }
        .clip-thumb.active { border-color: var(--primary); background: rgba(0,242,255,0.1); }

        /* Tools Row - Smaller Buttons */
        .tools { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .tool-btn {
            background: #252529; border: none; color: #ccc;
            padding: 8px 0; border-radius: 8px; font-size: 10px;
            display: flex; flex-direction: column; align-items: center;
        }
        .tool-btn i { font-size: 16px; margin-bottom: 2px; font-style: normal; }
        .tool-btn.active { color: var(--primary); background: #2a2a30; }

        /* Actions Row */
        .actions { display: flex; gap: 8px; }
        .btn-add { 
            flex: 1; background: #fff; color: #000; border: none;
            border-radius: 10px; font-weight: bold; font-size: 13px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-export { 
            flex: 2; background: var(--primary); color: #000; border: none;
            padding: 14px; border-radius: 10px; font-weight: 800; font-size: 13px;
        }

        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="logo">ELITE STUDIO</div>
        <div id="status" style="font-size: 10px; color: #666;">READY</div>
    </header>

    <div class="preview-area">
        <div id="overlay">
            <h1 id="pct" style="margin:0;">0%</h1>
            <p style="font-size:12px;">RENDERING...</p>
        </div>
        <canvas id="cvs"></canvas>
    </div>

    <div class="controls">
        <div class="timeline" id="timeline">
            <div style="width:100%; text-align:center; font-size:11px; color:#555;">No clips added</div>
        </div>

        <div class="tools">
            <button class="tool-btn active" id="modeStack" onclick="setMode('stack')"><i>üìö</i>Stack</button>
            <button class="tool-btn" id="modeSeq" onclick="setMode('seq')"><i>‚û°Ô∏è</i>Orderly</button>
            <button class="tool-btn" onclick="toggleFX('cracker')"><i>üéÜ</i>Cracker</button>
            <button class="tool-btn" onclick="toggleFX('scan')"><i>üéûÔ∏è</i>Scan</button>
        </div>

        <div class="actions">
            <label class="btn-add">
                ADD CLIPS <input type="file" multiple accept="video/*" onchange="load(event)" style="display:none">
            </label>
            <button class="btn-export" onclick="exportVid()">EXPORT 9:16</button>
        </div>
    </div>
</div>

<script>
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const clips = [];
    let mode = 'stack'; 
    let activeFX = 'none';
    let isExp = false;

    // Set high internal res, but CSS handles scaling
    cvs.width = 1080; cvs.height = 1920;

    function load(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const v = document.createElement('video');
            v.src = URL.createObjectURL(file);
            v.muted = true; v.loop = true; v.playsInline = true;
            v.onloadedmetadata = () => {
                clips.push(v); v.play();
                updateUI();
                if(clips.length === 1) requestAnimationFrame(loop);
            };
        });
    }

    function updateUI() {
        const tl = document.getElementById('timeline');
        tl.innerHTML = '';
        clips.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = 'clip-thumb';
            div.innerText = '#' + (i + 1);
            tl.appendChild(div);
        });
        document.getElementById('status').innerText = clips.length + " CLIPS";
    }

    function setMode(m) {
        mode = m;
        document.getElementById('modeStack').classList.toggle('active', m === 'stack');
        document.getElementById('modeSeq').classList.toggle('active', m === 'seq');
    }

    function toggleFX(fx) { activeFX = (activeFX === fx) ? 'none' : fx; }

    function loop() {
        if (!isExp) { draw(); requestAnimationFrame(loop); }
    }

    function draw() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,cvs.width,cvs.height);
        if(!clips.length) return;

        if (mode === 'stack') {
            const h = cvs.height / clips.length;
            clips.forEach((v, i) => drawFit(v, 0, i * h, cvs.width, h));
        } else {
            drawFit(clips[0], 0, 0, cvs.width, cvs.height);
        }

        if(activeFX === 'cracker') {
            ctx.fillStyle = `hsl(${Date.now()%360}, 100%, 50%)`;
            for(let i=0; i<5; i++) ctx.fillRect(Math.random()*cvs.width, Math.random()*cvs.height, 40, 40);
        }
        if(activeFX === 'scan') {
            ctx.fillStyle = 'rgba(0, 242, 255, 0.3)';
            ctx.fillRect(0, (Date.now()/5)%cvs.height, cvs.width, 10);
        }
    }

    function drawFit(v, x, y, w, h) {
        const vR = v.videoWidth / v.videoHeight;
        const tR = w / h;
        let dw, dh, dx, dy;
        if (vR > tR) { dh = h; dw = h * vR; dx = x + (w-dw)/2; dy = y; }
        else { dw = w; dh = w / vR; dx = x; dy = y + (h-dh)/2; }
        ctx.save(); ctx.beginPath(); ctx.rect(x,y,w,h); ctx.clip();
        ctx.drawImage(v, dx, dy, dw, dh); ctx.restore();
    }

    async function exportVid() {
        if (!clips.length) return;
        isExp = true;
        document.getElementById('overlay').style.display = 'flex';
        const stream = cvs.captureStream(30);
        const rec = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 12000000 });
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
            const b = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b); a.download = 'Short.webm'; a.click();
            location.reload();
        };
        rec.start();
        setTimeout(() => rec.stop(), clips[0].duration * 1000);
        const updateRec = () => { if(isExp) { draw(); requestAnimationFrame(updateRec); }};
        updateRec();
    }
</script>
</body>
</html>